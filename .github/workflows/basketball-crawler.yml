name: BasketballBund Crawler

on:
  schedule:
    # Run every second night at 2:00 AM (same as original crawler)
    - cron: '0 2 */2 * *'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('crawler/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r crawler/requirements.txt
        
    - name: Debug network connectivity
      run: |
        echo "Testing DNS resolution..."
        nslookup supabase.co || echo "DNS resolution failed for supabase.co"
        echo "Testing connectivity to basketball-bund.net..."
        curl -I https://www.basketball-bund.net || echo "Connection to basketball-bund.net failed"
        echo "Current environment variables (masked):"
        echo "SUPABASE_URL: ${{ secrets.SUPABASE_URL && 'SET' || 'NOT_SET' }}"
        echo "LEAGUE_ID: ${{ secrets.LEAGUE_ID }}"
        echo "Testing Supabase URL format..."
        if [ -n "${{ secrets.SUPABASE_URL }}" ]; then
          echo "Supabase URL format: ${{ secrets.SUPABASE_URL }}"
          # Extract hostname from URL for testing
          HOSTNAME=$(echo "${{ secrets.SUPABASE_URL }}" | sed -n 's|https://\([^/]*\).*|\1|p')
          echo "Extracted hostname: $HOSTNAME"
          nslookup "$HOSTNAME" || echo "DNS resolution failed for Supabase hostname: $HOSTNAME"
        fi
        
    - name: Run crawler with retry logic
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        LEAGUE_ID: ${{ secrets.LEAGUE_ID }}
      working-directory: ./crawler
      run: |
        # Add retry logic for network issues
        for i in {1..3}; do
          echo "Attempt $i of 3..."
          python main.py && break
          echo "Attempt $i failed, waiting 30 seconds before retry..."
          sleep 30
        done
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "BasketballBund crawler failed at $(date)"
        # You can add notification logic here (email, Slack, etc.)

  health-check:
    runs-on: ubuntu-latest
    needs: crawl
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r crawler/requirements.txt
        
    - name: Check recent data
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        LEAGUE_ID: ${{ secrets.LEAGUE_ID }}
      working-directory: ./crawler
      run: |
        echo "Starting health check..."
        
        # Validate environment variables first
        if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_KEY" ] || [ -z "$LEAGUE_ID" ]; then
          echo "ERROR: Missing required environment variables"
          echo "SUPABASE_URL: ${SUPABASE_URL:+SET}"
          echo "SUPABASE_KEY: ${SUPABASE_KEY:+SET}"
          echo "LEAGUE_ID: $LEAGUE_ID"
          exit 1
        fi
        
        echo "Testing DNS resolution for Supabase hostname..."
        HOSTNAME=$(echo "$SUPABASE_URL" | sed -n 's|https://\([^/]*\).*|\1|p')
        echo "Testing hostname: $HOSTNAME"
        nslookup "$HOSTNAME" || {
          echo "ERROR: DNS resolution failed for $HOSTNAME"
          exit 1
        }
        
        echo "Testing connectivity to Supabase..."
        curl -s -I "$SUPABASE_URL" || {
          echo "ERROR: Cannot connect to Supabase URL: $SUPABASE_URL"
          exit 1
        }
        
        echo "Running health check query..."
        python health_check.py
